#!/bin/bash
# Git passes: <local ref> <local sha1> <remote ref> <remote sha1>
while read local_ref local_sha remote_ref remote_sha
do
    # Handle new branches (comparing against an empty tree)
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        remote_sha=$(git hash-object -t tree /dev/null)
    fi

    # Get list of changed files
    files=$(git diff --name-only $remote_sha $local_sha)

    OPEN_CMD="open"
    [[ "$OSTYPE" == "linux-gnu"* ]] && OPEN_CMD="xdg-open"

    for file in $files; do
        content_a=$(git show $remote_sha:$file 2>/dev/null || echo "")
        content_b=$(git show $local_sha:$file 2>/dev/null || echo "")

        # Try to connect with timeout
        response=$(curl -s --max-time 5 -X POST http://localhost:8080/magic/new \
            -F "a=$content_a" \
            -F "b=$content_b" 2>/dev/null)

        # Check if curl succeeded
        if [ $? -eq 0 ] && [ ! -z "$response" ]; then
            res_id=$(echo $response | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')
            if [ ! -z "$res_id" ]; then
                URL="http://localhost:8080/magic?id=$res_id"
                echo "Successfully processed: $file"
                $OPEN_CMD "$URL" > /dev/null 2>&1
            else
                echo "Warning: Could not parse response for $file, skipping..."
            fi
        else
            echo "Warning: Magic diff service unavailable for $file, skipping..."
        fi
    done
done
exit 0